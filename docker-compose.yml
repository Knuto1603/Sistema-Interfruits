# ===================================
# Docker Compose para Desarrollo Local
# Simula exactamente el entorno de Railway
# ===================================

version: '3.8'

services:
  # ===================================
  # Backend API (Symfony)
  # ===================================
  api:
    build:
      context: .
      dockerfile: Dockerfile.api
    container_name: trazabilidad-api
    environment:
      - APP_ENV=dev
      - SYMFONY_ENV=dev
      - DATABASE_URL=mysql://root:123456@db:3306/sistema_trazabilidad?serverVersion=8.0&charset=utf8mb4
      - CORE_DATABASE_URL=mysql://root:123456@db:3306/sistema_trazabilidad?serverVersion=8.0&charset=utf8mb4
      - SECURITY_DATABASE_URL=mysql://root:123456@db:3306/sistema_trazabilidad?serverVersion=8.0&charset=utf8mb4
      - JWT_SECRET_KEY=config/jwt/private.pem
      - JWT_PUBLIC_KEY=config/jwt/public.pem
      - JWT_PASSPHRASE=c4906f9c855b52ecc705def9dd62b37baca62e0cbde1e109db968a50c33615dc
      - CORS_ALLOW_ORIGIN=^http://localhost:3000$
    ports:
      - "8080:8080"
    depends_on:
      - db
    volumes:
      - ./config/jwt:/app/config/jwt:ro
    networks:
      - trazabilidad
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ===================================
  # Frontend (Angular)  
  # ===================================
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    container_name: trazabilidad-frontend
    environment:
      - NODE_ENV=development
      - API_URL=http://localhost:8080
    ports:
      - "3000:8080"
    networks:
      - trazabilidad
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ===================================
  # Base de Datos (MySQL)
  # ===================================
  db:
    image: mysql:8.0
    container_name: trazabilidad-db
    environment:
      - MYSQL_ROOT_PASSWORD=123456
      - MYSQL_DATABASE=sistema_trazabilidad
      - MYSQL_USER=symfony
      - MYSQL_PASSWORD=symfony123
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./docker/mysql.conf:/etc/mysql/conf.d/custom.cnf:ro
    networks:
      - trazabilidad
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p123456"]
      interval: 30s
      timeout: 10s
      retries: 5

  # ===================================
  # Adminer (Opcional - para debug DB)
  # ===================================
  adminer:
    image: adminer
    container_name: trazabilidad-adminer
    ports:
      - "8081:8080"
    networks:
      - trazabilidad
    profiles:
      - debug

# ===================================
# Vol√∫menes y Redes
# ===================================
volumes:
  mysql_data:
    driver: local

networks:
  trazabilidad:
    driver: bridge
    name: sistema-trazabilidad
